-- This query returns the Retirements Per Lap for every race up until the 2023 Belgian GP
SELECT ra.raceId, 
		ra.year, 
		ra.name, 
		re.laps, 
		ret.retirements,
		ret.retirements/re.laps AS retirements_per_lap
FROM races AS ra
LEFT JOIN (
			-- Select only records for race winners. As the winner always completes the maximum laps, this can be used to determine the number of laps in the race
			SELECT raceId, laps
			FROM results
			WHERE position = '1') AS re
ON ra.raceId = re.raceId
LEFT JOIN (
			-- Select records where drivers started a race but did not finish
			SELECT DISTINCT ra.year, ra.name, ra.raceId, COUNT(*) AS retirements
			FROM results AS re
			LEFT JOIN status AS stat
			ON re.statusId = stat.statusId
			LEFT JOIN races AS ra
			ON re.raceId = ra.raceId
			WHERE stat.status NOT LIKE 'Finished' AND stat.status NOT LIKE '%Lap%' AND stat.status NOT LIKE 'Disqualified' AND re.grid NOT LIKE '0'
			GROUP BY ra.year, ra.name, ra.raceId) AS ret
ON ra.raceId = ret.raceId
ORDER BY retirements_per_lap DESC;
